#!/usr/bin/env groovy

import groovy.json.JsonOutput


node {
   stage('Preparation') { 
            git 'https://github.com/fchmainy/fch.attachWAF.git'   
       
            // Setting up environment variables
            echo "setting up variables..."
            env.appName = params.appName
            sh 'sudo mkdir /etc/ansible/roles/fch.attachWAF'
            sh 'sudo cp -fR * /etc/ansible/roles/fch.attachWAF'
   }
   
   stage('Attach ASM Policy') {
            withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'bigips', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]) {
               ansiblePlaybook(
                    colorized: true, 
                    inventory: '', 
                    playbook: 'playbook.yml', 
                    limit: '',
                    extras: '-vvv',
                    sudoUser: null,
                    extraVars: [
                        bigip_username: USERNAME,
                        bigip_password: PASSWORD,
                        appName: appName
                ])
            }
   
   stage('Approval') {
      input 'Work is done!'
   }
   }
}
